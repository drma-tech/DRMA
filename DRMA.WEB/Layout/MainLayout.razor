@using System.Security.Claims
@using Microsoft.JSInterop
@using Toolbelt.Blazor.PWA.Updater
@inherits LayoutComponentBase

@inject ISnackbar Snackbar
@inject IDialogService DialogService
@inject ILogger<MainLayout> Logger
@inject IJSRuntime JsRuntime

@inject NavigationManager Navigation

<MudThemeProvider @ref="_mudThemeProvider" IsDarkMode="@_darkMode" />
<MudPopoverProvider />
<MudDialogProvider />
<MudMessageBox />
<MudSnackbarProvider Style="top: 60px;" />

<PWAUpdater />

<MudLayout>
    <HeadLayout></HeadLayout>
    <MudMainContent>
        <MudContainer MaxWidth="MaxWidth.ExtraLarge" Class="@Css.Build().Medium("my")" Style="min-height: calc(100vh - 64px - 32px);">
            @Body
        </MudContainer>
        <FooterComponent></FooterComponent>
        <MudDivider Class="@Css.Build().Small("my").Large("mt")"></MudDivider>
        <MudText Align="Align.Center" Class="@Css.Build().Small("mb")">
            © 2025-@DateTime.Now.Year - DRMA Tech.
        </MudText>
    </MudMainContent>
</MudLayout>

@code {
    private MudThemeProvider? _mudThemeProvider;
    private bool _darkMode = false;

    protected override void OnInitialized()
    {
        try
        {
            // *************************************
            // attention: avoid using asynchronous calls here, as it may affect static html generation (especially for anonymous users)
            // *************************************

            AppStateStatic.DarkModeChanged += dark => { _darkMode = dark; StateHasChanged(); };
            AppStateStatic.ShowError += msg => { Snackbar.Add(msg, Severity.Error); };
            AppStateStatic.BreakpointChanged += breakpoint => StateHasChanged();
            AppStateStatic.BrowserWindowSizeChanged += size => StateHasChanged();
        }
        catch (Exception ex)
        {
            ex.ProcessException(Snackbar, Logger);
        }
    }

    /// <summary>
    /// Do not process anything here related to authenticated users. (use UserStateChanged instead)
    /// </summary>
    /// <param name="firstRender"></param>
    /// <returns></returns>
    protected override async Task OnAfterRenderAsync(bool firstRender)
    {
        await base.OnAfterRenderAsync(firstRender);

        if (firstRender)
        {
            try
            {
                await ApplyDarkMode();
            }
            catch (Exception ex)
            {
                ex.ProcessException(Snackbar, Logger);
            }
        }
    }

    private async Task ApplyDarkMode()
    {
        var darkMode = await AppStateStatic.GetDarkMode(JsRuntime);

        if (darkMode == null && _mudThemeProvider != null)
        {
            var system = await _mudThemeProvider.GetSystemDarkModeAsync();
            darkMode = system;

            await JsRuntime.Utils().SetStorage("dark-mode", darkMode ?? false);
        }

        AppStateStatic.ChangeDarkMode(darkMode ?? false);
    }

    [JSInvokable]
    public static void ShowError(string error)
    {
        AppStateStatic.ShowError?.Invoke(error);
    }

}
